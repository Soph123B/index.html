body, html {
    margin: 0;
    padding: 0;
    height: 100%;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #001929;
    color: #e0f7ff;
}
.game-container {
    display: flex;
    height: 100vh;
}
.sidebar {
    width: 250px;
    background-color: #003049;
    padding: 20px;
    overflow-y: auto;
    box-shadow: 0 0 15px rgba(0, 255, 255, 0.2);
}
.main-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    padding: 20px;
    background-color: #001929;
}
.chat-log {
    flex: 1;
    background-color: rgba(0, 60, 120, 0.3);
    padding: 20px;
    overflow-y: auto;
    border-radius: 10px;
    margin-bottom: 20px;
    box-shadow: 0 0 20px rgba(0, 255, 255, 0.1) inset;
}
.chat-message {
    margin-bottom: 15px;
    line-height: 1.5;
    padding: 10px;
    border-radius: 5px;
    background-color: rgba(0, 40, 80, 0.5);
}
.player-message {
    color: #00ffff;
    border-left: 3px solid #00ffff;
}
.dm-message {
    color: #80ffff;
    border-left: 3px solid #80ffff;
}
.other-player-message {
    color: #ff80ff;
    border-left: 3px solid #ff80ff;
}
.system-message {
    color: #80ff80;
    border-left: 3px solid #80ff80;
    font-style: italic;
}
.chat-input {
    display: flex;
    gap: 10px;
}
.chat-input input {
    flex: 1;
    padding: 10px;
    background-color: rgba(0, 60, 120, 0.3);
    border: 1px solid #00ffff;
    color: #e0f7ff;
    border-radius: 5px;
}
.chat-input button {
    padding: 10px 20px;
    background-color: #00a8e8;
    color: #001929;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    transition: background-color 0.3s;
}
.chat-input button:hover {
    background-color: #00ffff;
}
.loading {
    text-align: center;
    color: #80ffff;
    font-style: italic;
}
h2 {
    color: #00ffff;
    border-bottom: 2px solid #00ffff;
    padding-bottom: 5px;
    margin-top: 0;
    text-shadow: 0 0 5px rgba(0, 255, 255, 0.5);
}
ul {
    list-style-type: none;
    padding: 0;
}
li {
    margin-bottom: 5px;
}
.stat {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 5px;
}
.character-info {
    background-color: rgba(0, 60, 120, 0.3);
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 15px;
    box-shadow: 0 0 10px rgba(0, 255, 255, 0.1);
}
.editable {
    background-color: rgba(0, 40, 80, 0.5);
    border: 1px solid #00a8e8;
    color: #e0f7ff;
    padding: 5px;
    width: 100%;
    margin-bottom: 5px;
    border-radius: 3px;
}
.editable:focus {
    outline: none;
    box-shadow: 0 0 5px #00ffff;
}
.xp-container {
    display: flex;
    align-items: center;
    gap: 5px;
}
.xp-container input {
    width: 45%;
}
@keyframes glow {
    0% { box-shadow: 0 0 5px #00ffff; }
    50% { box-shadow: 0 0 20px #00ffff, 0 0 30px #00a8e8; }
    100% { box-shadow: 0 0 5px #00ffff; }
}
.sidebar, .main-content, .chat-log, .character-info {
    animation: glow 4s infinite;
}
.party-member {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 5px;
    background-color: rgba(0, 60, 120, 0.3);
    border-radius: 5px;
    margin-bottom: 5px;
}
.avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    border: 2px solid #00ffff;
}
</style></head><body>
<div class="game-container">
    <div class="sidebar">
        <div class="character-info">
            <h2>Character</h2>
            <input type="text" id="charName" class="editable" value="" placeholder="Name">
            <input type="text" id="charRace" class="editable" value="" placeholder="Race">
            <input type="text" id="charClass" class="editable" value="" placeholder="Class">
            <input type="number" id="charLevel" class="editable" value="1" placeholder="Level">
            <div class="xp-container">
                <input type="number" id="charXP" class="editable" value="0" placeholder="XP">
                <span>/</span>
                <input type="number" id="charMaxXP" class="editable" value="300" placeholder="Max XP">
            </div>
        </div>
        <h2>Stats</h2>
        <ul id="statsList">
            <li class="stat"><span>Strength:</span> <input type="number" id="charStrength" class="editable" value="8"></li>
            <li class="stat"><span>Dexterity:</span> <input type="number" id="charDexterity" class="editable" value="8"></li>
            <li class="stat"><span>Constitution:</span> <input type="number" id="charConstitution" class="editable" value="8"></li>
            <li class="stat"><span>Intelligence:</span> <input type="number" id="charIntelligence" class="editable" value="8"></li>
            <li class="stat"><span>Wisdom:</span> <input type="number" id="charWisdom" class="editable" value="8"></li>
            <li class="stat"><span>Charisma:</span> <input type="number" id="charCharisma" class="editable" value="8"></li>
        </ul>
        <h2>Inventory</h2>
        <textarea id="inventoryList" class="editable" rows="6">
</textarea>
        <h2>Quests</h2>
        <textarea id="questsList" class="editable" rows="4">
</textarea>
        <div id="partyList"></div>
    </div>
    <div class="main-content">
        <div class="chat-log" id="chatLog">
            <div class="chat-message dm-message">Welcome to AD&IM, adventurer! Before we begin your journey in this realm of arcane wonders, please tell me your name, race, and class. Also, is there anywhere in particular you'd like to start your adventure? Perhaps a bustling city, a mysterious forest, or an ancient ruin? Let your imagination spark and let me know!</div>
        </div>
        <form id="chatForm" class="chat-input">
            <input type="text" id="userInput" placeholder="Describe your action or ask the DM something..." required>
            <button type="submit">Send</button>
        </form>
    </div>
    <div class="sidebar">
        <h2>Equipment</h2>
        <textarea id="equipmentList" class="editable" rows="6">
</textarea>
        <h2>Spells & Abilities</h2>
        <textarea id="spellsList" class="editable" rows="6">
</textarea>
        <h2>Known NPCs</h2>
        <textarea id="npcList" class="editable" rows="4">
</textarea>
    </div>
</div>

<script>
async function loadCharacter() {
    const characters = await room.collection('character')
        .filter({ username: room.party.client.username })
        .getList();
    
    if (characters.length > 0) {
        const character = characters[0];
        document.getElementById('charName').value = character.name || '';
        document.getElementById('charRace').value = character.race || '';
        document.getElementById('charClass').value = character.class || '';
        document.getElementById('charLevel').value = character.level || '1';
        document.getElementById('charXP').value = character.xp || '0';
        document.getElementById('charMaxXP').value = character.maxXp || '300';
        
        if (character.stats) {
            for (const [stat, value] of Object.entries(character.stats)) {
                document.getElementById('char' + stat.charAt(0).toUpperCase() + stat.slice(1)).value = value;
            }
        }
        
        document.getElementById('inventoryList').value = character.inventory || '';
        document.getElementById('questsList').value = character.quests || '';
        document.getElementById('equipmentList').value = character.equipment || '';
        document.getElementById('spellsList').value = character.spells || '';
        document.getElementById('npcList').value = character.npcs || '';
    }
}

async function saveCharacter() {
    const characterData = {
        name: document.getElementById('charName').value,
        race: document.getElementById('charRace').value,
        class: document.getElementById('charClass').value,
        level: document.getElementById('charLevel').value,
        xp: document.getElementById('charXP').value,
        maxXp: document.getElementById('charMaxXP').value,
        stats: {
            strength: document.getElementById('charStrength').value,
            dexterity: document.getElementById('charDexterity').value,
            constitution: document.getElementById('charConstitution').value,
            intelligence: document.getElementById('charIntelligence').value,
            wisdom: document.getElementById('charWisdom').value,
            charisma: document.getElementById('charCharisma').value
        },
        inventory: document.getElementById('inventoryList').value,
        quests: document.getElementById('questsList').value,
        equipment: document.getElementById('equipmentList').value,
        spells: document.getElementById('spellsList').value,
        npcs: document.getElementById('npcList').value
    };

    const characters = await room.collection('character')
        .filter({ username: room.party.client.username })
        .getList();
    
    if (characters.length > 0) {
        await room.collection('character').update(characters[0].id, characterData);
    } else {
        await room.collection('character').create(characterData);
    }
}

function setupCharacterFieldSync() {
    const fields = [
        'charName', 'charRace', 'charClass', 'charLevel', 
        'charXP', 'charMaxXP', 'charStrength', 'charDexterity', 
        'charConstitution', 'charIntelligence', 'charWisdom', 
        'charCharisma', 'inventoryList', 'questsList', 
        'equipmentList', 'spellsList', 'npcList'
    ];

    fields.forEach(fieldId => {
        const element = document.getElementById(fieldId);
        if (element) {
            element.addEventListener('change', () => {
                sendCharacterUpdate();
            });
        }
    });
}

function sendCharacterUpdate() {
    const characterInfo = {
        name: document.getElementById('charName').value,
        race: document.getElementById('charRace').value,
        class: document.getElementById('charClass').value,
        level: document.getElementById('charLevel').value,
        xp: document.getElementById('charXP').value,
        maxXp: document.getElementById('charMaxXP').value,
        stats: {
            strength: document.getElementById('charStrength').value,
            dexterity: document.getElementById('charDexterity').value,
            constitution: document.getElementById('charConstitution').value,
            intelligence: document.getElementById('charIntelligence').value,
            wisdom: document.getElementById('charWisdom').value,
            charisma: document.getElementById('charCharisma').value
        },
        inventory: document.getElementById('inventoryList').value,
        quests: document.getElementById('questsList').value,
        equipment: document.getElementById('equipmentList').value,
        spells: document.getElementById('spellsList').value,
        npcs: document.getElementById('npcList').value
    };

    room.send({
        type: "character_update",
        character: characterInfo
    });
}

function handleCharacterUpdate(data) {
    if (data.clientId !== room.party.client.id) {
        if (data.character) {
            document.getElementById('charName').value = data.character.name;
            document.getElementById('charRace').value = data.character.race;
            document.getElementById('charClass').value = data.character.class;
            document.getElementById('charLevel').value = data.character.level;
            document.getElementById('charXP').value = data.character.xp;
            document.getElementById('charMaxXP').value = data.character.maxXp;
            
            for (const [stat, value] of Object.entries(data.character.stats)) {
                document.getElementById('char' + stat.charAt(0).toUpperCase() + stat.slice(1)).value = value;
            }
            
            document.getElementById('inventoryList').value = data.character.inventory;
            document.getElementById('questsList').value = data.character.quests;
            document.getElementById('equipmentList').value = data.character.equipment;
            document.getElementById('spellsList').value = data.character.spells;
            document.getElementById('npcList').value = data.character.npcs;
        }
        
        const chatLog = document.getElementById('chatLog');
        const updateMessage = document.createElement('div');
        updateMessage.className = 'chat-message system-message';
        updateMessage.textContent = `${data.username} updated their character sheet`;
        chatLog.appendChild(updateMessage);
        chatLog.scrollTop = chatLog.scrollHeight;
    }
}

document.addEventListener('DOMContentLoaded', setupCharacterFieldSync);

window.addEventListener('load', () => {
    loadCharacter();
    setupAutoSave();
});

function setupAutoSave() {
    const fields = document.querySelectorAll('.editable');
    fields.forEach(field => {
        field.addEventListener('change', () => {
            saveCharacter();
        });
    });
}

const room = new WebsimSocket();
let partyMembers = {};

room.party.subscribe((peers) => {
    partyMembers = peers;
    updatePartyList();
});

room.onmessage = (event) => {
    const data = event.data;
    switch (data.type) {
        case "connected":
            console.log(`${data.username} connected`);
            break;
        case "disconnected":
            console.log(`${data.username} disconnected`);
            break;
        case "character_update":
            handleCharacterUpdate(data);
            break;
        case "chat_message":
            handleChatMessage(data);
            break;
    }
};

function updatePartyList() {
    let partyListDiv = document.getElementById('partyList');
    if (!partyListDiv) {
        partyListDiv = document.createElement('div');
        partyListDiv.id = 'partyList';
        document.querySelector('.sidebar').insertBefore(partyListDiv, document.querySelector('.character-info'));
    }
    
    partyListDiv.innerHTML = '<h2>Party Members</h2>';
    const list = document.createElement('ul');
    for (const clientId in partyMembers) {
        const { username, avatarUrl } = partyMembers[clientId];
        const li = document.createElement('li');
        li.className = 'party-member';
        li.innerHTML = `
            <img src="${avatarUrl}" alt="${username}" class="avatar">
            <span>${username}</span>
        `;
        list.appendChild(li);
    }
    partyListDiv.appendChild(list);
}

function handleChatMessage(data) {
    const chatLog = document.getElementById('chatLog');
    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message ${data.clientId === room.party.client.id ? 'player-message' : 'other-player-message'}`;
    messageDiv.innerHTML = `<strong>${data.username}:</strong> ${data.message}`;
    chatLog.appendChild(messageDiv);
    chatLog.scrollTop = chatLog.scrollHeight;
}

document.getElementById('chatForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const userInput = document.getElementById('userInput');
    const chatLog = document.getElementById('chatLog');
    
    room.send({
        type: "chat_message",
        message: userInput.value
    });
    
    const loadingMessage = document.createElement('div');
    loadingMessage.className = 'chat-message loading';
    loadingMessage.textContent = 'AI DM is weaving the narrative...';
    chatLog.appendChild(loadingMessage);
    
    try {
        const data = await converseWithWebSim(JSON.stringify({
            message: userInput.value,
            context: 'AD&IM fantasy RPG setting',
            characterInfo: {
                name: document.getElementById('charName').value,
                race: document.getElementById('charRace').value,
                class: document.getElementById('charClass').value,
                level: document.getElementById('charLevel').value,
                xp: document.getElementById('charXP').value,
                maxXp: document.getElementById('charMaxXP').value,
                stats: {
                    strength: document.getElementById('charStrength').value,
                    dexterity: document.getElementById('charDexterity').value,
                    constitution: document.getElementById('charConstitution').value,
                    intelligence: document.getElementById('charIntelligence').value,
                    wisdom: document.getElementById('charWisdom').value,
                    charisma: document.getElementById('charCharisma').value
                },
                inventory: document.getElementById('inventoryList').value,
                quests: document.getElementById('questsList').value,
                equipment: document.getElementById('equipmentList').value,
                spells: document.getElementById('spellsList').value,
                npcs: document.getElementById('npcList').value
            }
        }));
        
        chatLog.removeChild(loadingMessage);
        
        const dmMessage = document.createElement('div');
        dmMessage.className = 'chat-message dm-message';
        dmMessage.textContent = 'AI DM: ' + data.response;
        chatLog.appendChild(dmMessage);
        
        if (data.characterUpdates) {
            updateCharacterSheet(data.characterUpdates);
            room.send({
                type: "character_update",
                updates: data.characterUpdates
            });
        }
        
        chatLog.scrollTop = chatLog.scrollHeight;
    } catch (error) {
        console.error('Error:', error);
        chatLog.removeChild(loadingMessage);
        
        const errorMessage = document.createElement('div');
        errorMessage.className = 'chat-message';
        errorMessage.textContent = 'A surge of wild magic disrupted the communication. Please try again.';
        chatLog.appendChild(errorMessage);
    }
    
    userInput.value = '';
});

function updateCharacterSheet(updates) {
    for (const [key, value] of Object.entries(updates)) {
        const element = document.getElementById(key);
        if (element) {
            if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
                element.value = value;
            } else {
                element.textContent = value;
            }
        } else if (key === 'stats') {
            for (const [stat, statValue] of Object.entries(value)) {
                const statElement = document.getElementById('char' + stat.charAt(0).toUpperCase() + stat.slice(1));
                if (statElement) {
                    statElement.value = statValue;
                }
            }
        } else if (key === 'inventory') {
            document.getElementById('inventoryList').value = value;
        } else if (key === 'quests') {
            document.getElementById('questsList').value = value;
        } else if (key === 'equipment') {
            document.getElementById('equipmentList').value = value;
        } else if (key === 'spells') {
            document.getElementById('spellsList').value = value;
        } else if (key === 'npcs') {
            document.getElementById('npcList').value = value;
        }
    }
}
</script>

</body></html>